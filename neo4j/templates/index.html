<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Neo4j</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .sidebar {
            width: 320px; background: #2c3e50; color: white;
            display: flex; flex-direction: column; padding: 20px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1); z-index: 10;
        }

        h1 { font-size: 1.2rem; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; margin-top: 0; }
        label { display: block; margin-top: 15px; font-size: 0.9rem; color: #bdc3c7; }
        
        /* CAMBIO: Inputs en lugar de Select para permitir b√∫squeda */
        input[list], select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: none; box-sizing: border-box;}
        input[list], select { background: #fff; color: #333; }
        
        .menu-opt {
            background: #34495e; color: white; text-align: left; margin-top: 5px;
            cursor: pointer; transition: 0.2s; border: 1px solid #465f76;
            width: 100%; /* Asegurar ancho */
        }
        .menu-opt:hover, .menu-opt.active { background: #e74c3c; border-color: #c0392b; }

        #dynamic-form {
            margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2);
            border-radius: 8px; display: none;
        }
        
        .action-btn { background: #27ae60; color: white; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .action-btn:hover { background: #2ecc71; }

        /* AREA PRINCIPAL */
        #main-container { flex-grow: 1; position: relative; background: #ecf0f1; display: flex; justify-content: center; align-items: center;}
        
        #network { width: 100%; height: 100%; position: absolute; top:0; left:0; }

        /* OVERLAYS */
        #info-overlay {
            z-index: 5; background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 80%; max-height: 80%;
            overflow-y: auto; display: none; text-align: center;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #2c3e50; color: white; }
        tr:hover { background: #f1f1f1; }

        .error-msg { color: #c0392b; font-size: 1.2rem; font-weight: bold; }

        .legend {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px;
            font-size: 0.8rem; pointer-events: none; z-index: 6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .dot { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>Consola Pr√°ctica 2 Neo4j</h1>
    
    <div id="menu-list">
        <button class="menu-opt" onclick="sel(1)">1. Consultar L√≠nea</button>
        <button class="menu-opt" onclick="sel(2)">2. Hubs Universitarios</button>
        <button class="menu-opt" onclick="sel(3)">3. Estaciones con Renfe</button>
        <button class="menu-opt" onclick="sel(4)">4. Campus por Estudio</button>
        <button class="menu-opt" onclick="sel(5)">5. Resumen Universidades</button>
        <button class="menu-opt" onclick="sel(6)">6. Ruta Estaci√≥n -> Campus</button>
        <button class="menu-opt" onclick="sel(7)">7. Ruta Estaci√≥n -> Grado</button>
    </div>

    <div id="dynamic-form">
        <h3 id="form-title" style="margin-top:0; font-size:1rem;">Opciones</h3>
        
        <div id="input-linea" class="field" style="display:none;">
            <label>Selecciona L√≠nea:</label>
            <select id="sel-linea"></select> </div>

        <div id="input-estudio" class="field" style="display:none;">
            <label>Busca Grado/M√°ster:</label>
            <input list="list-estudios" id="inp-estudio" placeholder="Escribe para buscar...">
            <datalist id="list-estudios"></datalist>
        </div>

        <div id="input-origen" class="field" style="display:none;">
            <label>Estaci√≥n Origen:</label>
            <input list="list-estaciones" id="inp-origen" placeholder="Nombre estaci√≥n...">
            <datalist id="list-estaciones"></datalist>
        </div>

        <div id="input-campus" class="field" style="display:none;">
            <label>Campus Destino:</label>
            <select id="sel-campus"></select> </div>

        <button class="action-btn" onclick="ejecutar()">VISUALIZAR</button>
    </div>
    
    <div id="status" style="margin-top: auto; font-size: 0.8rem; color: #bdc3c7;">Esperando...</div>
</div>

<div id="main-container">
    <div id="network"></div>
    <div id="info-overlay"></div> 
    
    <div class="legend">
        <div><span class="dot" style="background:#3498db;"></span>Estaci√≥n</div>
        <div><span class="dot" style="background:#e74c3c;"></span>Campus</div>
        <div><span class="dot" style="background:#f1c40f;"></span>Estudio</div>
        <div><span class="dot" style="border: 2px solid #e74c3c; background:white;"></span>Conexi√≥n</div>
        <div style="margin-top:5px; font-style:italic;">* Pasa el rat√≥n para ver detalles</div>
    </div>
</div>

<script>
    let currentOption = 0;
    let network = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/init')
            .then(r => r.json())
            .then(data => {
                // Rellenamos selects normales
                llenarSelect('sel-linea', data.lineas);
                llenarSelect('sel-campus', data.campus);
                
                // Rellenamos las listas de b√∫squeda (Datalists)
                llenarDatalist('list-estaciones', data.estaciones);
                llenarDatalist('list-estudios', data.estudios);
            });
    });

    function llenarSelect(id, lista) {
        const s = document.getElementById(id);
        s.innerHTML = ""; // Limpiar previos
        lista.forEach(item => s.add(new Option(item, item)));
    }

    // Nueva funci√≥n para rellenar las listas de b√∫squeda
    function llenarDatalist(id, lista) {
        const d = document.getElementById(id);
        d.innerHTML = "";
        lista.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            d.appendChild(opt);
        });
    }

    function sel(opcion) {
        currentOption = opcion;
        document.querySelectorAll('.menu-opt').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('dynamic-form').style.display = 'block';
        document.querySelectorAll('.field').forEach(f => f.style.display = 'none');
        document.getElementById('info-overlay').style.display = 'none';

        const title = document.getElementById('form-title');
        
        // L√≥gica de visualizaci√≥n de campos
        if(opcion === 1) {
            title.innerText = "Ver L√≠nea";
            document.getElementById('input-linea').style.display = 'block';
        } else if(opcion === 2 || opcion === 3 || opcion === 5) {
            title.innerText = "Consulta Directa";
        } else if(opcion === 4) {
            title.innerText = "Buscar Campus por Grado";
            document.getElementById('input-estudio').style.display = 'block';
        } else if(opcion === 6) {
            title.innerText = "Ruta a Campus";
            document.getElementById('input-origen').style.display = 'block';
            document.getElementById('input-campus').style.display = 'block';
        } else if(opcion === 7) {
            title.innerText = "Ruta para Estudiar...";
            document.getElementById('input-origen').style.display = 'block';
            document.getElementById('input-estudio').style.display = 'block';
        }
    }

    function ejecutar() {
        // Recogemos valores dependiendo de si es Select o Input
        const lineaVal = document.getElementById('sel-linea').value;
        const campusVal = document.getElementById('sel-campus').value;
        const origenVal = document.getElementById('inp-origen').value;
        const estudioVal = document.getElementById('inp-estudio').value;

        // Validaciones b√°sicas
        if ((currentOption === 6 || currentOption === 7) && !origenVal) {
            alert("Por favor, introduce una estaci√≥n de origen.");
            return;
        }
        if ((currentOption === 4 || currentOption === 7) && !estudioVal) {
            alert("Por favor, selecciona un estudio.");
            return;
        }

        const payload = {
            opcion: String(currentOption),
            data: {
                linea: lineaVal,
                estudio: estudioVal,
                origen: origenVal,
                campus: campusVal
            }
        };

        const status = document.getElementById('status');
        const overlay = document.getElementById('info-overlay');
        const netContainer = document.getElementById('network');
        
        status.innerText = "Consultando Neo4j...";
        overlay.style.display = 'none';

        fetch('/api/accion', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
            
            if (data.type === 'table') {
                netContainer.style.visibility = 'hidden';
                mostrarTabla(data.data);
                status.innerText = "Tabla cargada.";
                return;
            }

            if (!data.nodes || data.nodes.length === 0) {
                let msg = "No se encontraron resultados.";
                if(currentOption === 2) msg = "üö´ No hay hubs universitarios.";
                if(currentOption === 6 || currentOption === 7) msg = "‚ùå No se ha encontrado ruta posible (o revisa los nombres).";
                
                mostrarMensaje(msg);
                status.innerText = "Sin resultados.";
                netContainer.style.visibility = 'hidden';
                return;
            }

            netContainer.style.visibility = 'visible';
            dibujar(data);
            status.innerText = `Mostrando ${data.nodes.length} nodos.`;
        })
        .catch(e => { console.error(e); status.innerText = "Error de conexi√≥n"; });
    }

    function mostrarTabla(datos) {
        const overlay = document.getElementById('info-overlay');
        let html = `<h3>Resumen Acad√©mico</h3>
                    <table>
                        <thead><tr><th>Universidad</th><th>Grados</th><th>M√°sters</th></tr></thead>
                        <tbody>`;
        
        datos.forEach(row => {
            html += `<tr>
                        <td>${row.universidad}</td>
                        <td>${row.grados}</td>
                        <td>${row.masters}</td>
                     </tr>`;
        });
        html += `</tbody></table>`;
        
        overlay.innerHTML = html;
        overlay.style.display = 'block';
    }

    function mostrarMensaje(msg) {
        const overlay = document.getElementById('info-overlay');
        overlay.innerHTML = `<div class="error-msg">${msg}</div>`;
        overlay.style.display = 'block';
    }

    function dibujar(data) {
        const container = document.getElementById('network');
        
        const graphData = {
            nodes: new vis.DataSet(data.nodes),
            edges: new vis.DataSet(data.edges)
        };

        const options = {
            nodes: {
                shape: 'dot', size: 20, 
                font: {size: 14, color: '#333', strokeWidth: 2, strokeColor: '#fff'}, 
                borderWidth: 2,
                shadow: true
            },
            edges: {
                width: 2, 
                smooth: { type: 'continuous' }, 
                color: {color:'#bdc3c7', highlight:'#2c3e50'},
                arrows: { to: { scaleFactor: 0.5 } } // Flechas m√°s discretas
            },
            groups: {
                Estacion: { color: {background:'#3498db', border:'#2980b9'} },
                Campus:   { shape:'box', color:{background:'#e74c3c', border:'#c0392b'}, font:{color:'white'} },
                Estudio:  { shape:'star', color:{background:'#f1c40f', border:'#f39c12'}, size: 30 },
                Linea:    { shape:'diamond', color:{background:'#2ecc71', border:'#27ae60'}, size: 20 },
                Default:  { color: '#95a5a6' }
            },
            physics: {
                stabilization: false,
                barnesHut: { 
                    gravitationalConstant: -3000, 
                    springConstant: 0.04,
                    springLength: 150 
                }
            },
            interaction: { hover: true, tooltipDelay: 200 }
        };

        if(network) network.destroy();
        network = new vis.Network(container, graphData, options);
    }
</script>

</body>
</html>
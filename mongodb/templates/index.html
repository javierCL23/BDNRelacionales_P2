<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel MongoDB</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --bg: #fffaf8cd; --success: #27ae60; --blue: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--primary); }
        .container { max-width: 1000px; margin: auto; background: rgb(253, 252, 251); padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Sistema de Pestañas */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e1e4e8; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: #e1e4e8; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .card { border: 1px solid #e1e4e8; padding: 20px; border-radius: 8px; background: #fff; margin-bottom: 15px; }
        h1 { text-align: center; color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 10px; }
        h3 { margin-top: 0; color: var(--primary); border-left: 5px solid var(--accent); padding-left: 10px; }
        
        label { display: block; margin: 10px 0 5px; font-weight: 600; font-size: 0.85rem; }
        select, input { width: 100%; padding: 10px; border: 1px solid #d1d5da; border-radius: 6px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        .btn-del { background: var(--primary); color: white; }
        .btn-upd { background: var(--primary); color: white; }
        .btn-add { background: var(--primary); color: white; }
        .btn-query { background: var(--primary); color: white; }
        
        .info-tag { font-size: 0.75rem; color: #666; font-style: italic; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>Consola Práctica 2 MongoDB</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(event, 'crud')">Operaciones CRUD</button>
        <button class="tab-btn" onclick="switchTab(event, 'consultas')">Consultas de Lectura</button>
        <button class="tab-btn" onclick="switchTab(event, 'agregaciones')">Agregaciones (pipelines)</button>
    </div>

    <div id="crud" class="tab-content active">
        <div class="grid">
            <div class="card">
                <h3>Gestión de Metro</h3>
                <form action="/api/metro/borrar" method="POST">
                    <label>Eliminar Línea:</label>
                    <select name="linea_id" class="selector-lineas">
                        <option value="">Cargando líneas...</option>
                    </select>
                    <button type="submit" class="btn-del">Eliminar Línea Permanentemente</button>
                </form>
                <p class="info-tag">Elimina la línea y actualiza la información de las estaciones pertenecientes a esta.</p>
                <hr>
                <form action="/api/metro/cortar" method="POST">
                    <label>Línea Afectada:</label>
                    <select name="linea_id" class="selector-lineas" onchange="cargarEstaciones(this.value, 'corte')">
                        <option value="">Seleccione una línea...</option>
                    </select>
                    <label>Desde:</label>
                    <select name="estacion_inicio" id="corte-inicio"></select>
                    <label>Hasta:</label>
                    <select name="estacion_fin" id="corte-fin"></select>
                    <button type="submit" class="btn-upd">Marcar Tramo "No Accesible"</button>
                </form>
                <p class="info-tag">Cortar la línea marcando un tramo como no accesible.</p>
            </div>

            <div class="card">
                <h3>Gestión Académica</h3>
                <form action="/api/estudios/actualizar" method="POST">
                    <label>Campus:</label>
                    <select name="campus_id" class="selector-campus" onchange="cargarEstudiosDelCampus(this.value)">
                        <option value="">Seleccione un campus...</option>
                    </select>
                    <label>Estudio:</label>
                    <select name="estudio_id" id="selector-estudios-filtrados"></select>
                    <label></label>
                    <input type="text" name="coordinador" required placeholder="Nuevo responsable">
                    <button type="submit" class="btn-upd">Actualizar Coordinador</button>
                </form>
                <p class="info-tag">Permite actualizar el nombre del coordinador de una titulación en un campus.</p>

                <hr>
                <form action="/api/estudios/nuevo" method="POST">
                    <input type="text" name="nombre" required placeholder="Nombre del Título">
                    <div style="display: flex; gap: 10px;">
                        <input type="number" name="creditos" placeholder="Créditos">
                        <select name="tipo">
                            <option value="GRADO">GRADO</option>
                            <option value="MÁSTER">MÁSTER</option>
                        </select>
                    </div>
                    <label>Campus:</label>
                    <select name="campus_id" class="selector-campus"></select>
                    <label></label>
                    <input type="text" name="coordinador_init" placeholder="Coordinador inicial">
                    <button type="submit" class="btn-add">Registrar Nuevo Estudio</button>
                </form>
                <p class="info-tag">Permite añadir una nueva titulación con su información.</p>

            </div>
        </div>
    </div>

    <div id="consultas" class="tab-content">
        <div class="grid">
            <div class="card">
                <h3>Consultas de Transporte</h3>
                
                <form action="/api/consultas/estaciones-linea" method="GET">
                    <label>Estaciones de una línea (ordenadas):</label>
                    <select name="linea_id" class="selector-lineas"></select>
                    <button type="submit" class="btn-query">Listar Recorrido</button>
                </form>
                <p class="info-tag">Listado de estaciones de una línea por orden de parada.</p>
                <hr>

                <form action="/api/consultas/estaciones-renfe" method="GET">
                    <label>Estaciones con correspondencia Renfe:</label>
                    <button type="submit" class="btn-query">Ver Estaciones Renfe</button>
                </form>
                <p class="info-tag">Estaciones que, además de metro, conectan con Renfe.</p>
                <hr>

                <form action="/api/consultas/accesibilidad-zona" method="GET">
                    <label>Estaciones accesibles por zona:</label>
                    <select name="zona" id="selector-zonas-consultas">
                        <option value="">Cargando zonas...</option>
                    </select>
                    <button type="submit" class="btn-query">Filtrar por Zona</button>
                </form>
                <p class="info-tag">Desglose de estaciones que tienen grado de accesibilidad T.</p>

            </div>

            <div class="card">
                <h3>Consultas Académicas</h3>
                <form action="/api/consultas/campus-universidad" method="GET">
                    <label>Campus por Universidad:</label>
                    <select name="universidad" id="selector-universidades-consultas">
                        <option value="">Cargando universidades...</option>
                    </select>
                    <button type="submit" class="btn-query">Ver Campus</button>
                </form>
                <p class="info-tag">Desglose de campus por universidad.</p>
                <hr>

                <form action="/api/consultas/campus-estacion" method="GET">
                    <label>Campus asociados a estación principal:</label>
                    <select name="estacion_nombre" id="selector-estaciones-todas">
                        <option value="">Cargando estaciones...</option>
                    </select>
                    <button type="submit" class="btn-query">Buscar Campus</button>
                </form>
                <hr>

                <form action="/api/consultas/grados-detalle" method="GET">
                    <label>Detalle completo de Grados:</label>
                    <input type="text" name="nombre_grado" placeholder="Grado contiene... (opcional)">
                    <button type="submit" class="btn-query">Listar Estudios</button>
                </form>
                <p class="info-tag">Listado de grados (si no se filtra por regex. -> probar con 'ar').</p>
            </div>
        </div>
    </div>

    <div id="agregaciones" class="tab-content">
        <div class="grid">
            <div class="card">
                <h3>Análisis de Metro</h3>
                
                <form action="/api/agregaciones/estaciones-por-linea" method="GET">
                    <label>Ranking: Número de estaciones por línea:</label>
                    <button type="submit" class="btn-query">Calcular ranking</button>
                    <p class="info-tag">Calcula el total de estaciones agrupando por línea.</p>
                </form>

                <hr>

                <form action="/api/agregaciones/comparar-trayectos" method="GET">
                    <label>Comparación de distancia en línea:</label>
                    <select name="linea_id" class="selector-lineas" onchange="cargarEstacionesParaComparar(this.value)">
                        <option value="">Seleccione línea...</option>
                    </select>
                    <div style="display: flex; gap: 5px; margin-top:10px;">
                        <select name="estacion_a" id="comp-estacion-a"></select>
                        <select name="estacion_b" id="comp-estacion-b"></select>
                    </div>
                    <button type="submit" class="btn-query">Calcular Distancia entre paradas</button>
                    <p class="info-tag">Determina la cantidad de paradas entre medias.</p>
                </form>

            </div>
            
            <div class="card">
                <h3>Análisis de Universidad</h3>
                
                <form action="/api/agregaciones/estudios-universidad" method="GET">
                    <label>Oferta académica (Grado vs Máster) por Universidad:</label>
                    <button type="submit" class="btn-query">Calcular Totales</button>
                    <p class="info-tag">Desglose de títulos ofrecidos por cada universidad.</p>
                </form>
                <hr>
                
                <form action="/api/agregaciones/universitarias-por-zona" method="GET">
                    <label>Estaciones "Universitarias" por Zona:</label>
                    <button type="submit" class="btn-query">Calcular distribución</button>
                    <p class="info-tag">Cuenta estaciones conectadas a campus en cada zona tarifaria.</p>
                </form>
                <hr>

                <form action="/api/agregaciones/recomendacion" method="GET">
                    
                    <label>1. ¿En qué línea estás?:</label>
                    <select name="linea_id" class="selector-lineas" onchange="cargarEstacionesRecomendador(this.value)">
                        <option value="">Seleccione línea...</option>
                    </select>

                    <label>2. ¿En qué estación?:</label>
                    <select name="estacion_origen" id="rec-estacion-origen" disabled>
                        <option value="">Seleccione primero una línea...</option>
                    </select>

                    <label>3. Grado deseado:</label>
                    <input type="text" name="nombre_grado" required placeholder="Ej: Informática">

                    <button type="submit" class="btn-query">Calcular Mejor Opción</button>
                </form>
                <p class="info-tag">Localiza el campus más cercano (en número de paradas) dentro de tu línea actual.</p>            </div>
        </div>
    </div>

</div>

<script>
    function switchTab(evt, tabName) {
        const contents = document.getElementsByClassName("tab-content");
        for (let content of contents) content.classList.remove("active");
        const buttons = document.getElementsByClassName("tab-btn");
        for (let btn of buttons) btn.classList.remove("active");
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/data/opciones')
            .then(res => res.json())
            .then(data => {
                console.log("Datos recibidos de la API:", data);

                // 1. Rellenar todas las Líneas (usando clase para llegar a todos los selectores)
                const selLineas = document.querySelectorAll('.selector-lineas');
                data.lineas.forEach(l => {
                    selLineas.forEach(select => {
                        const opt = document.createElement('option');
                        opt.value = l; opt.textContent = `Línea ${l}`;
                        select.appendChild(opt);
                    });
                });

                // 2. Rellenar todos los Campus
                const selCampus = document.querySelectorAll('.selector-campus');
                data.campus.forEach(c => {
                    selCampus.forEach(select => {
                        const opt = document.createElement('option');
                        opt.value = c; opt.textContent = c;
                        select.appendChild(opt);
                    });
                });

                // 3. Rellenar Universidades (el que te faltaba)
                const selUnivs = document.getElementById('selector-universidades-consultas');
                if (selUnivs && data.universidades) {
                    selUnivs.innerHTML = ""; // Limpia el "Cargando..."
                    data.universidades.forEach(u => {
                        const opt = document.createElement('option');
                        opt.value = u; opt.textContent = u;
                        selUnivs.appendChild(opt);
                    });
                }

                // 4. Rellenar Zonas
                const selZonas = document.getElementById('selector-zonas-consultas');
                if (selZonas && data.zonas) {
                    selZonas.innerHTML = "";
                    data.zonas.forEach(z => {
                        const opt = document.createElement('option');
                        opt.value = z; opt.textContent = `Zona ${z}`;
                        selZonas.appendChild(opt);
                    });
                }
                // 5. Rellenar el selector de todas las estaciones para búsqueda de campus
                const selEstacionesBusqueda = document.getElementById('selector-estaciones-todas');
                if (selEstacionesBusqueda && data.estaciones_lista) {
                    selEstacionesBusqueda.innerHTML = '<option value="">Seleccione una estación...</option>';
                    data.estaciones_lista.forEach(est => {
                        const opt = document.createElement('option');
                        opt.value = est; // El valor ya viene en el formato correcto
                        opt.textContent = est;
                        selEstacionesBusqueda.appendChild(opt);
                    });
                }
            })
            .catch(err => console.error("Error al poblar selectores:", err));
    });

    function cargarEstaciones(lineaId, tipo) {
        fetch(`/api/data/estaciones/${lineaId}`)
            .then(res => res.json())
            .then(estaciones => {
                const inicio = document.getElementById('corte-inicio');
                const fin = document.getElementById('corte-fin');
                inicio.innerHTML = ""; fin.innerHTML = "";
                estaciones.forEach(est => {
                    let opt = `<option value="${est}">${est}</option>`;
                    inicio.innerHTML += opt;
                    fin.innerHTML += opt;
                });
            });
    }

    function cargarEstudiosDelCampus(campusNombre) {
        fetch(`/api/data/estudios_por_campus/${campusNombre}`)
            .then(res => res.json())
            .then(estudios => {
                const selEstudios = document.getElementById('selector-estudios-filtrados');
                selEstudios.innerHTML = "";
                estudios.forEach(e => {
                    selEstudios.innerHTML += `<option value="${e}">${e}</option>`;
                });
            });
    }

    function cargarEstacionesParaComparar(lineaId) {
        fetch(`/api/data/estaciones/${lineaId}`)
            .then(res => res.json())
            .then(estaciones => {
                const selA = document.getElementById('comp-estacion-a');
                const selB = document.getElementById('comp-estacion-b');
                selA.innerHTML = ""; selB.innerHTML = "";
                estaciones.forEach(est => {
                    let opt = `<option value="${est}">${est}</option>`;
                    selA.innerHTML += opt;
                    selB.innerHTML += opt;
                });
            });
    }

    function cargarEstacionesRecomendador(lineaId) {
        const selector = document.getElementById('rec-estacion-origen');
        
        if(!lineaId) {
            selector.innerHTML = '<option value="">Seleccione primero una línea...</option>';
            selector.disabled = true;
            return;
        }

        selector.disabled = false;
        selector.innerHTML = '<option>Cargando...</option>';

        fetch(`/api/data/estaciones/${lineaId}`)
            .then(res => res.json())
            .then(estaciones => {
                selector.innerHTML = "";
                estaciones.forEach(est => {
                    let opt = document.createElement('option');
                    opt.value = est;
                    opt.textContent = est;
                    selector.appendChild(opt);
                });
            })
            .catch(err => {
                console.error(err);
                selector.innerHTML = '<option>Error cargando</option>';
            });
    }
</script>

</body>
</html>